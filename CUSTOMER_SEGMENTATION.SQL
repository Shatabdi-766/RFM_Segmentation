CREATE VIEW RFM_SEGMENT AS
WITH RFM_INITIAL_CALCULATION AS (
    SELECT
        CUSTOMERNAME,
        ROUND(SUM(SALES), 0) AS MONETARY_VALUE,
        COUNT(ORDERNUMBER) AS FREQUENCY,
        MAX(STR_TO_DATE(`ORDERDATE_1`, '%d/%m/%y')) AS RECENT_ORDER_DATE
    FROM `sales_data_for_rfm_segmentation`
    GROUP BY CUSTOMERNAME
),
RFM_SCORE_CALCULATION AS (
    SELECT
        C.*,
        NTILE(4) OVER (ORDER BY RECENT_ORDER_DATE DESC) AS RFM_RECENCY_SCORE,
        NTILE(4) OVER (ORDER BY FREQUENCY DESC) AS RFM_FREQUENCY_SCORE,
        NTILE(4) OVER (ORDER BY MONETARY_VALUE DESC) AS RFM_MONETARY_SCORE
    FROM RFM_INITIAL_CALCULATION AS C
)
SELECT
    R.CUSTOMERNAME,
    (R.RFM_RECENCY_SCORE + R.RFM_FREQUENCY_SCORE + R.RFM_MONETARY_SCORE) AS RFM_TOTAL_SCORE,
    CONCAT_WS('', R.RFM_RECENCY_SCORE, R.RFM_FREQUENCY_SCORE, R.RFM_MONETARY_SCORE) AS RFM_CATEGORY_COMBINATION
FROM
    RFM_SCORE_CALCULATION AS R;
    
   DROP VIEW RFM_SEGMENTT; 
   
   SELECT * FROM RFM_SEGMENT;
   
   SELECT DISTINCT RFM_CATEGORY_COMBINATION
FROM RFM_SEGMENT
ORDER BY 1;
   
   
SELECT 
    CUSTOMERNAME,
    CASE
        WHEN RFM_CATEGORY_COMBINATION IN (111, 112, 121, 123, 132, 211, 211, 212, 114, 141) THEN 'CHURNED CUSTOMER'
        WHEN RFM_CATEGORY_COMBINATION IN (133, 134, 143, 244, 334, 343, 344, 144) THEN 'SLIPPING AWAY, CANNOT LOSE'
        WHEN RFM_CATEGORY_COMBINATION IN (311, 411, 331) THEN 'NEW CUSTOMERS'
        WHEN RFM_CATEGORY_COMBINATION IN (222, 231, 221,  223, 233, 322) THEN 'POTENTIAL CHURNERS'
        WHEN RFM_CATEGORY_COMBINATION IN (323, 333,321, 341, 422, 332, 432) THEN 'ACTIVE'
        WHEN RFM_CATEGORY_COMBINATION IN (433, 434, 443, 444) THEN 'LOYAL'
    ELSE 'CANNOT BE DEFINED'
    END AS CUSTOMER_SEGMENT

FROM RFM_SEGMENT;

WITH CTE1 AS (
SELECT 
    CUSTOMERNAME,
    CASE
        WHEN RFM_CATEGORY_COMBINATION IN (111, 112, 121, 123, 132, 211, 211, 212, 114, 141) THEN 'CHURNED CUSTOMER'
        WHEN RFM_CATEGORY_COMBINATION IN (133, 134, 143, 244, 334, 343, 344, 144) THEN 'SLIPPING AWAY, CANNOT LOSE'
        WHEN RFM_CATEGORY_COMBINATION IN (311, 411, 331) THEN 'NEW CUSTOMERS'
        WHEN RFM_CATEGORY_COMBINATION IN (222, 231, 221,  223, 233, 322) THEN 'POTENTIAL CHURNERS'
        WHEN RFM_CATEGORY_COMBINATION IN (323, 333,321, 341, 422, 332, 432) THEN 'ACTIVE'
        WHEN RFM_CATEGORY_COMBINATION IN (433, 434, 443, 444) THEN 'LOYAL'
    ELSE 'CANNOT BE DEFINED'
    END AS CUSTOMER_SEGMENT

FROM RFM_SEGMENT)

SELECT CUSTOMER_SEGMENT , COUNT(*) AS NUMBER_OF_CUSTOMERS
FROM CTE1
GROUP BY 1
ORDER BY 2 DESC;

